## Анализ результатов

### PUT

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>2500 запросов в секунду</li>
</ol>

![CPU PUT](/async-svg/cpu-put.svg)

Ресурсы процесса выделяются на следующие направления:
<ol>
<li>Запуск Java-потока - 57.81%</li>
<li>Работа асинхронного клиента - 14.44%</li>
<li>Исполнение селектора потоков onenio - 16.27%</li>
<li>Нативные Java-вызовы - 9%</li>
</ol>

Большую часть ресурсов Java-потока используют обработка *CompletableFuture* и последующая обработка задач асинхронным клиентом.

![ALLOC PUT](/async-svg/alloc-put.svg)

Память выделяется на Java-поток (50.57%), селектор потоков onenio (45.45%) и селектор асинхронного клиента (3.74%). Обработка *CompletableFuture* в Java-потоке по потреблению памяти сопоставима с работой сессии onenio.

![LOCK PUT](/async-svg/lock-put.svg)

Большая часть блокировок приходится на Java-поток (64.07%) и асинхронный клиент (28.85%). Блокировки Java-потока распространяются на *CompletableFuture*, обработку задач из пула потоков и обработка задач асинхронного клиента.

```
wrk2 -t4 -c64 -d2m -R2500 -s wrk/put.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 4.782ms, rate sampling interval: 18ms
  Thread calibration: mean lat.: 4.843ms, rate sampling interval: 18ms
  Thread calibration: mean lat.: 4.826ms, rate sampling interval: 18ms
  Thread calibration: mean lat.: 4.738ms, rate sampling interval: 18ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     5.98ms   12.25ms 174.21ms   93.00%
    Req/Sec   642.97    173.76     2.18k    83.94%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    2.33ms
 75.000%    3.99ms
 90.000%   12.90ms
 99.000%   70.14ms
 99.900%  118.97ms
 99.990%  139.90ms
 99.999%  166.01ms
100.000%  174.34ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.208     0.000000            1         1.00
       1.131     0.100000        27527         1.11
       1.453     0.200000        54991         1.25
       1.732     0.300000        82485         1.43
       2.015     0.400000       109937         1.67
       2.331     0.500000       137504         2.00
       2.513     0.550000       151140         2.22
       2.731     0.600000       164920         2.50
       3.003     0.650000       178656         2.86
       3.377     0.700000       192402         3.33
       3.989     0.750000       206101         4.00
       4.511     0.775000       213003         4.44
       5.299     0.800000       219855         5.00
       6.603     0.825000       226725         5.71
       8.191     0.850000       233599         6.67
      10.039     0.875000       240454         8.00
      11.335     0.887500       243893         8.89
      12.903     0.900000       247326        10.00
      14.647     0.912500       250761        11.43
      17.071     0.925000       254193        13.33
      20.111     0.937500       257629        16.00
      22.063     0.943750       259344        17.78
      24.223     0.950000       261078        20.00
      26.767     0.956250       262785        22.86
      30.095     0.962500       264502        26.67
      35.199     0.968750       266213        32.00
      38.431     0.971875       267083        35.56
      42.303     0.975000       267936        40.00
      46.495     0.978125       268791        45.71
      51.551     0.981250       269652        53.33
      57.311     0.984375       270508        64.00
      60.735     0.985938       270940        71.11
      64.191     0.987500       271366        80.00
      67.903     0.989062       271800        91.43
      71.743     0.990625       272226       106.67
      76.351     0.992188       272660       128.00
      78.783     0.992969       272868       142.22
      81.087     0.993750       273087       160.00
      84.287     0.994531       273304       182.86
      87.359     0.995313       273512       213.33
      92.031     0.996094       273731       256.00
      94.527     0.996484       273835       284.44
      97.279     0.996875       273943       320.00
     100.095     0.997266       274051       365.71
     104.127     0.997656       274160       426.67
     107.519     0.998047       274265       512.00
     109.887     0.998242       274317       568.89
     112.191     0.998437       274372       640.00
     114.815     0.998633       274425       731.43
     117.055     0.998828       274479       853.33
     119.167     0.999023       274533      1024.00
     121.023     0.999121       274559      1137.78
     122.239     0.999219       274586      1280.00
     123.775     0.999316       274613      1462.86
     125.887     0.999414       274639      1706.67
     127.871     0.999512       274667      2048.00
     129.215     0.999561       274680      2275.56
     130.239     0.999609       274693      2560.00
     131.327     0.999658       274707      2925.71
     132.351     0.999707       274724      3413.33
     133.503     0.999756       274733      4096.00
     134.271     0.999780       274740      4551.11
     135.679     0.999805       274750      5120.00
     136.191     0.999829       274754      5851.43
     137.087     0.999854       274762      6826.67
     138.239     0.999878       274767      8192.00
     139.135     0.999890       274770      9102.22
     140.031     0.999902       274774     10240.00
     140.671     0.999915       274777     11702.86
     142.591     0.999927       274780     13653.33
     145.279     0.999939       274784     16384.00
     146.559     0.999945       274785     18204.44
     148.223     0.999951       274787     20480.00
     155.007     0.999957       274789     23405.71
     155.263     0.999963       274791     27306.67
     157.055     0.999969       274792     32768.00
     157.951     0.999973       274793     36408.89
     158.335     0.999976       274794     40960.00
     160.639     0.999979       274795     46811.43
     160.639     0.999982       274795     54613.33
     164.095     0.999985       274796     65536.00
     166.015     0.999986       274797     72817.78
     166.015     0.999988       274797     81920.00
     166.527     0.999989       274798     93622.86
     166.527     0.999991       274798    109226.67
     166.527     0.999992       274798    131072.00
     173.183     0.999993       274799    145635.56
     173.183     0.999994       274799    163840.00
     173.183     0.999995       274799    187245.71
     173.183     0.999995       274799    218453.33
     173.183     0.999996       274799    262144.00
     174.335     0.999997       274800    291271.11
     174.335     1.000000       274800          inf
#[Mean    =        5.981, StdDeviation   =       12.250]
#[Max     =      174.208, Total count    =       274800]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  299937 requests in 2.00m, 19.16MB read
Requests/sec:   2499.41
Transfer/sec:    163.54KB
```

Итоги:
<ol>
<li>обработано 299937 запросов</li>
<li>прочитано 19.16MB данных</li>
<li>сервер выдерживает заданную нагрузку на уровне 2499.41 зап/с</li>
</ol>

### GET

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>1500 запросов в секунду</li>
</ol>

![CPU GET](/async-svg/cpu-get.svg)

Ресурсы процесса выделяются на следующие направления:
<ol>
<li>Запуск Java-потока - 87.59%</li>
<li>Работа асинхронного клиента - 4.89%</li>
<li>Исполнение селектора потоков onenio - 4.59%</li>
<li>Нативные Java-вызовы - 3%</li>
</ol>

Большую часть ресурсов Java-потока используют обработка *CompletableFuture* (76.44%).

![ALLOC GET](/async-svg/alloc-get.svg)

Память выделяется на Java-поток (45.69%) и селектор потоков onenio (50.34%). Обработка *CompletableFuture* в Java-потоке по потреблению памяти сопоставима с работой сессии onenio.

![LOCK GET](/async-svg/lock-get.svg)

Большая часть блокировок приходится на Java-поток (69.11%) и асинхронный клиент (27.79%). Блокировки Java-потока распространяются на *CompletableFuture*, обработку задач из пула потоков и обработка задач асинхронного клиента.

```
wrk2 -t4 -c64 -d2m -R1500 -s wrk/get.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 7.246ms, rate sampling interval: 32ms
  Thread calibration: mean lat.: 7.288ms, rate sampling interval: 32ms
  Thread calibration: mean lat.: 7.540ms, rate sampling interval: 33ms
  Thread calibration: mean lat.: 7.143ms, rate sampling interval: 32ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.69ms   23.70ms 234.75ms   90.60%
    Req/Sec   380.60     70.37   843.00     81.98%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    4.49ms
 75.000%    8.98ms
 90.000%   33.38ms
 99.000%  125.18ms
 99.900%  180.48ms
 99.990%  209.41ms
 99.999%  219.13ms
100.000%  234.88ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.660     0.000000            1         1.00
       2.203     0.100000        16502         1.11
       2.665     0.200000        32988         1.25
       3.111     0.300000        49471         1.43
       3.697     0.400000        65984         1.67
       4.487     0.500000        82458         2.00
       4.971     0.550000        90732         2.22
       5.551     0.600000        98928         2.50
       6.407     0.650000       107174         2.86
       7.487     0.700000       115428         3.33
       8.975     0.750000       123666         4.00
      10.047     0.775000       127777         4.44
      11.311     0.800000       131902         5.00
      13.079     0.825000       136025         5.71
      15.951     0.850000       140150         6.67
      21.295     0.875000       144269         8.00
      26.655     0.887500       146331         8.89
      33.375     0.900000       148387        10.00
      40.031     0.912500       150450        11.43
      46.527     0.925000       152514        13.33
      53.727     0.937500       154575        16.00
      58.303     0.943750       155604        17.78
      63.615     0.950000       156630        20.00
      69.503     0.956250       157664        22.86
      75.967     0.962500       158706        26.67
      83.455     0.968750       159725        32.00
      87.679     0.971875       160237        35.56
      92.031     0.975000       160761        40.00
      97.087     0.978125       161273        45.71
     102.527     0.981250       161784        53.33
     108.735     0.984375       162297        64.00
     112.511     0.985938       162555        71.11
     116.799     0.987500       162813        80.00
     121.983     0.989062       163070        91.43
     127.295     0.990625       163330       106.67
     133.503     0.992188       163585       128.00
     137.599     0.992969       163718       142.22
     141.311     0.993750       163843       160.00
     145.151     0.994531       163974       182.86
     149.631     0.995313       164101       213.33
     154.879     0.996094       164233       256.00
     156.671     0.996484       164294       284.44
     159.615     0.996875       164359       320.00
     163.455     0.997266       164426       365.71
     166.527     0.997656       164487       426.67
     169.983     0.998047       164552       512.00
     171.775     0.998242       164584       568.89
     173.567     0.998437       164616       640.00
     175.999     0.998633       164649       731.43
     177.919     0.998828       164683       853.33
     180.863     0.999023       164713      1024.00
     182.911     0.999121       164729      1137.78
     185.087     0.999219       164745      1280.00
     186.623     0.999316       164761      1462.86
     188.543     0.999414       164777      1706.67
     192.767     0.999512       164793      2048.00
     194.175     0.999561       164801      2275.56
     195.839     0.999609       164809      2560.00
     197.375     0.999658       164817      2925.71
     199.167     0.999707       164825      3413.33
     202.239     0.999756       164835      4096.00
     202.623     0.999780       164837      4551.11
     203.775     0.999805       164841      5120.00
     205.567     0.999829       164845      5851.43
     206.463     0.999854       164849      6826.67
     208.127     0.999878       164853      8192.00
     208.639     0.999890       164855      9102.22
     209.407     0.999902       164857     10240.00
     211.967     0.999915       164859     11702.86
     213.375     0.999927       164861     13653.33
     214.399     0.999939       164863     16384.00
     214.527     0.999945       164864     18204.44
     215.167     0.999951       164865     20480.00
     215.679     0.999957       164867     23405.71
     215.679     0.999963       164867     27306.67
     217.215     0.999969       164868     32768.00
     217.343     0.999973       164869     36408.89
     217.343     0.999976       164869     40960.00
     219.135     0.999979       164871     46811.43
     219.135     0.999982       164871     54613.33
     219.135     0.999985       164871     65536.00
     219.135     0.999986       164871     72817.78
     219.135     0.999988       164871     81920.00
     225.023     0.999989       164872     93622.86
     225.023     0.999991       164872    109226.67
     225.023     0.999992       164872    131072.00
     225.023     0.999993       164872    145635.56
     225.023     0.999994       164872    163840.00
     234.879     0.999995       164873    187245.71
     234.879     1.000000       164873          inf
#[Mean    =       12.688, StdDeviation   =       23.704]
#[Max     =      234.752, Total count    =       164873]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  179968 requests in 2.00m, 15.92MB read
Requests/sec:   1499.72
Transfer/sec:    135.84KB
```

Итоги:
<ol>
<li>обработано 179968 запросов</li>
<li>прочитано 15.92MB данных</li>
<li>сервер выдерживает заданную нагрузку на уровне 1499.72 зап/с</li>
</ol>

##Выводы

Возвращение к использованию отдельного *ExecutorService* вместо встроенного в onenio улучшило нагрузочные характеристики сервиса. Теперь сервис может обрабатывать большее количество любых запросов за то же самое время. Внедрение механизма *CompletableFuture* вместо асинхронного исполнения onenio увеличило выделение ресурсов и памяти на Java-поток.