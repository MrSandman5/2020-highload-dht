## Анализ результатов

### PUT

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>3000 запросов в секунду</li>
</ol>

![CPU PUT](/async-svg/cpu-put.svg)

Ресурсы процесса выделяются на следующие направления:
<ol>
<li>Запуск Java-потока - 57.81%</li>
<li>Работа асинхронного клиента - 14.44%</li>
<li>Исполнение селектора потоков onenio - 16.27%</li>
<li>Нативные Java-вызовы - 9%</li>
</ol>

Большую часть ресурсов Java-потока используют обработка *CompletableFuture* и последующая обработка задач асинхронным клиентом.

![ALLOC PUT](/async-svg/alloc-put.svg)

Память выделяется на Java-поток (50.57%), селектор потоков onenio (45.45%) и селектор асинхронного клиента (3.74%). Обработка *CompletableFuture* в Java-потоке по потреблению памяти сопоставима с работой сессии onenio.

![LOCK PUT](/async-svg/lock-put.svg)

Большая часть блокировок приходится на Java-поток (64.07%) и асинхронный клиент (28.85%). Блокировки Java-потока распространяются на *CompletableFuture*, обработку задач из пула потоков и обработка задач асинхронного клиента.

```
wrk2 -t4 -c64 -d2m -R3000 -s wrk/put.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.316ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.306ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.296ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.302ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.30ms    4.70ms  94.08ms   94.95%
    Req/Sec   790.45    176.72     3.11k    84.50%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.34ms
 75.000%    1.79ms
 90.000%    3.08ms
 99.000%   24.37ms
 99.900%   62.49ms
 99.990%   82.05ms
 99.999%   90.82ms
100.000%   94.14ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.222     0.000000            1         1.00
       0.700     0.100000        33087         1.11
       0.881     0.200000        65951         1.25
       1.043     0.300000        99047         1.43
       1.192     0.400000       131914         1.67
       1.339     0.500000       165013         2.00
       1.413     0.550000       181587         2.22
       1.488     0.600000       197927         2.50
       1.574     0.650000       214381         2.86
       1.674     0.700000       230903         3.33
       1.792     0.750000       247336         4.00
       1.863     0.775000       255667         4.44
       1.946     0.800000       263872         5.00
       2.051     0.825000       272079         5.71
       2.197     0.850000       280298         6.67
       2.447     0.875000       288553         8.00
       2.683     0.887500       292663         8.89
       3.077     0.900000       296798        10.00
       3.649     0.912500       300909        11.43
       4.447     0.925000       305037        13.33
       5.571     0.937500       309149        16.00
       6.251     0.943750       311208        17.78
       7.075     0.950000       313273        20.00
       8.059     0.956250       315332        22.86
       9.287     0.962500       317394        26.67
      10.775     0.968750       319456        32.00
      11.695     0.971875       320488        35.56
      12.799     0.975000       321522        40.00
      14.239     0.978125       322543        45.71
      16.071     0.981250       323575        53.33
      18.575     0.984375       324603        64.00
      20.031     0.985938       325120        71.11
      21.567     0.987500       325635        80.00
      23.183     0.989062       326149        91.43
      25.135     0.990625       326664       106.67
      27.599     0.992188       327182       128.00
      28.991     0.992969       327437       142.22
      30.751     0.993750       327696       160.00
      32.831     0.994531       327953       182.86
      35.199     0.995313       328213       213.33
      37.855     0.996094       328469       256.00
      39.327     0.996484       328597       284.44
      41.343     0.996875       328725       320.00
      43.583     0.997266       328856       365.71
      46.079     0.997656       328984       426.67
      49.343     0.998047       329111       512.00
      51.551     0.998242       329176       568.89
      54.111     0.998437       329241       640.00
      56.959     0.998633       329307       731.43
      60.063     0.998828       329370       853.33
      62.751     0.999023       329433      1024.00
      64.671     0.999121       329467      1137.78
      66.623     0.999219       329501      1280.00
      68.031     0.999316       329530      1462.86
      70.079     0.999414       329562      1706.67
      71.615     0.999512       329595      2048.00
      72.511     0.999561       329611      2275.56
      73.535     0.999609       329627      2560.00
      74.367     0.999658       329643      2925.71
      75.647     0.999707       329661      3413.33
      77.375     0.999756       329676      4096.00
      78.143     0.999780       329683      4551.11
      78.655     0.999805       329692      5120.00
      79.231     0.999829       329699      5851.43
      80.127     0.999854       329708      6826.67
      81.407     0.999878       329716      8192.00
      81.791     0.999890       329719      9102.22
      82.047     0.999902       329723     10240.00
      82.559     0.999915       329728     11702.86
      82.879     0.999927       329731     13653.33
      83.391     0.999939       329735     16384.00
      83.583     0.999945       329737     18204.44
      83.967     0.999951       329739     20480.00
      84.479     0.999957       329741     23405.71
      85.695     0.999963       329743     27306.67
      86.527     0.999969       329745     32768.00
      86.847     0.999973       329746     36408.89
      87.231     0.999976       329747     40960.00
      87.679     0.999979       329748     46811.43
      88.831     0.999982       329749     54613.33
      89.407     0.999985       329750     65536.00
      89.919     0.999986       329751     72817.78
      89.919     0.999988       329751     81920.00
      90.815     0.999989       329752     93622.86
      90.815     0.999991       329752    109226.67
      90.943     0.999992       329753    131072.00
      90.943     0.999993       329753    145635.56
      90.943     0.999994       329753    163840.00
      92.479     0.999995       329754    187245.71
      92.479     0.999995       329754    218453.33
      92.479     0.999996       329754    262144.00
      92.479     0.999997       329754    291271.11
      92.479     0.999997       329754    327680.00
      94.143     0.999997       329755    374491.43
      94.143     1.000000       329755          inf
#[Mean    =        2.302, StdDeviation   =        4.697]
#[Max     =       94.080, Total count    =       329755]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  359914 requests in 2.00m, 23.00MB read
Requests/sec:   2999.31
Transfer/sec:    196.24KB
```

Итоги:
<ol>
<li>обработано 359914 запросов</li>
<li>прочитано 23.00MB данных</li>
<li>сервер выдерживает заданную нагрузку на уровне 2999.31 зап/с</li>
</ol>

### GET

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>1500 запросов в секунду</li>
</ol>

![CPU GET](/async-svg/cpu-get.svg)

Ресурсы процесса выделяются на следующие направления:
<ol>
<li>Запуск Java-потока - 87.59%</li>
<li>Работа асинхронного клиента - 4.89%</li>
<li>Исполнение селектора потоков onenio - 4.59%</li>
<li>Нативные Java-вызовы - 3%</li>
</ol>

Большую часть ресурсов Java-потока используют обработка *CompletableFuture* (76.44%).

![ALLOC GET](/async-svg/alloc-get.svg)

Память выделяется на Java-поток (45.69%) и селектор потоков onenio (50.34%). Обработка *CompletableFuture* в Java-потоке по потреблению памяти сопоставима с работой сессии onenio.

![LOCK GET](/async-svg/lock-get.svg)

Большая часть блокировок приходится на Java-поток (69.11%) и асинхронный клиент (27.79%). Блокировки Java-потока распространяются на *CompletableFuture*, обработку задач из пула потоков и обработка задач асинхронного клиента.

```
wrk2 -t4 -c64 -d2m -R1500 -s wrk/get.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 2.103ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.106ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.066ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.062ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.17ms    1.68ms  37.31ms   93.21%
    Req/Sec   395.31     83.22     1.22k    68.59%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.80ms
 75.000%    2.28ms
 90.000%    3.11ms
 99.000%    9.73ms
 99.900%   19.65ms
 99.990%   25.89ms
 99.999%   28.70ms
100.000%   37.34ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.429     0.000000            1         1.00
       1.149     0.100000        16504         1.11
       1.352     0.200000        33035         1.25
       1.513     0.300000        49467         1.43
       1.662     0.400000        66030         1.67
       1.804     0.500000        82496         2.00
       1.878     0.550000        90703         2.22
       1.957     0.600000        98981         2.50
       2.046     0.650000       107179         2.86
       2.149     0.700000       115431         3.33
       2.277     0.750000       123748         4.00
       2.347     0.775000       127830         4.44
       2.429     0.800000       131896         5.00
       2.531     0.825000       136074         5.71
       2.659     0.850000       140189         6.67
       2.829     0.875000       144263         8.00
       2.951     0.887500       146328         8.89
       3.109     0.900000       148404        10.00
       3.321     0.912500       150444        11.43
       3.625     0.925000       152504        13.33
       4.067     0.937500       154567        16.00
       4.367     0.943750       155598        17.78
       4.691     0.950000       156626        20.00
       5.063     0.956250       157665        22.86
       5.503     0.962500       158698        26.67
       6.063     0.968750       159722        32.00
       6.391     0.971875       160233        35.56
       6.763     0.975000       160750        40.00
       7.175     0.978125       161264        45.71
       7.647     0.981250       161778        53.33
       8.255     0.984375       162293        64.00
       8.599     0.985938       162553        71.11
       8.967     0.987500       162808        80.00
       9.415     0.989062       163067        91.43
       9.919     0.990625       163324       106.67
      10.551     0.992188       163583       128.00
      11.007     0.992969       163709       142.22
      11.519     0.993750       163839       160.00
      12.127     0.994531       163968       182.86
      12.823     0.995313       164096       213.33
      13.631     0.996094       164224       256.00
      14.095     0.996484       164289       284.44
      14.663     0.996875       164355       320.00
      15.311     0.997266       164419       365.71
      15.999     0.997656       164482       426.67
      16.895     0.998047       164546       512.00
      17.327     0.998242       164579       568.89
      17.759     0.998437       164612       640.00
      18.255     0.998633       164643       731.43
      18.943     0.998828       164675       853.33
      19.727     0.999023       164707      1024.00
      20.127     0.999121       164724      1137.78
      20.415     0.999219       164740      1280.00
      20.847     0.999316       164756      1462.86
      21.647     0.999414       164773      1706.67
      22.479     0.999512       164788      2048.00
      22.751     0.999561       164796      2275.56
      22.943     0.999609       164804      2560.00
      23.295     0.999658       164812      2925.71
      23.807     0.999707       164821      3413.33
      24.223     0.999756       164828      4096.00
      24.575     0.999780       164832      4551.11
      24.735     0.999805       164837      5120.00
      24.863     0.999829       164841      5851.43
      25.119     0.999854       164844      6826.67
      25.551     0.999878       164848      8192.00
      25.695     0.999890       164850      9102.22
      25.887     0.999902       164852     10240.00
      26.063     0.999915       164854     11702.86
      26.127     0.999927       164856     13653.33
      26.543     0.999939       164858     16384.00
      26.591     0.999945       164859     18204.44
      26.783     0.999951       164860     20480.00
      26.959     0.999957       164861     23405.71
      27.439     0.999963       164862     27306.67
      27.551     0.999969       164863     32768.00
      27.711     0.999973       164864     36408.89
      27.711     0.999976       164864     40960.00
      27.935     0.999979       164865     46811.43
      27.935     0.999982       164865     54613.33
      28.703     0.999985       164866     65536.00
      28.703     0.999986       164866     72817.78
      28.703     0.999988       164866     81920.00
      31.807     0.999989       164867     93622.86
      31.807     0.999991       164867    109226.67
      31.807     0.999992       164867    131072.00
      31.807     0.999993       164867    145635.56
      31.807     0.999994       164867    163840.00
      37.343     0.999995       164868    187245.71
      37.343     1.000000       164868          inf
#[Mean    =        2.172, StdDeviation   =        1.683]
#[Max     =       37.312, Total count    =       164868]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  179964 requests in 2.00m, 15.92MB read
Requests/sec:   1499.70
Transfer/sec:    135.84KB
```

Итоги:
<ol>
<li>обработано 179964 запросов</li>
<li>прочитано 15.92MB данных</li>
<li>сервер выдерживает заданную нагрузку на уровне 1499.7 зап/с</li>
</ol>

##Выводы

После реализации асинхронного клиента для http-сервиса допустимая нагрузка PUT-запросами выросла с 2500 зап/с до 3000 зап/с, а допустимая нагрузка GET-запросами выросла с 750 зап/с до 1500 зап/с. Скорость исполнения запросов при этом кардинально не уменьшилась.
При анализе профилирование не было обнаружено существенных изменений в использовании ресурсов как для PUT-запросов, так и для GET-запросов.