## Анализ результатов

### PUT

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>1000 запросов в секунду</li>
</ol>

![CPU PUT](/async-svg/cpu-put.svg)

Ресурсы процессора выделяются на Java-поток (57.89%) (также включает выбор задач из пулла потоков) и селектор потоков onenio (38.16%), остатки уходят на нативные функции Java. Проксирование клиентов, исполнение PUT-запроса и формирование ответа берут ресурсов примерно поровну.

![ALLOC PUT](/async-svg/alloc-put.svg)

Память выделяется на Java-поток (67.26%) и селектор потоков onenio (32.74%). Операция проксирования клиентов сервиса занимает 48.21%, остальное уходить на исполнение PUT-запроса (13.91%) и формирование ответа (4.61%).

![LOCK PUT](/async-svg/lock-put.svg)

Одна блокировка на один Java-поток, так как выполняется однопоточное профилирование.

```
wrk2 -t4 -c64 -d2m -R1000 -s wrk/put.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.174ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.230ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.218ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.233ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   836.98us  710.85us  42.21ms   96.96%
    Req/Sec   215.09     96.32     1.00k    65.34%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  795.00us
 75.000%    1.08ms
 90.000%    1.24ms
 99.000%    1.84ms
 99.900%    6.64ms
 99.990%   33.25ms
 99.999%   41.38ms
100.000%   42.24ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.085     0.000000            1         1.00
       0.357     0.100000         8983         1.11
       0.480     0.200000        17895         1.25
       0.607     0.300000        26845         1.43
       0.709     0.400000        35871         1.67
       0.795     0.500000        44724         2.00
       0.846     0.550000        49233         2.22
       0.908     0.600000        53691         2.50
       0.970     0.650000        58158         2.86
       1.032     0.700000        62667         3.33
       1.075     0.750000        67092         4.00
       1.097     0.775000        69352         4.44
       1.125     0.800000        71591         5.00
       1.158     0.825000        73793         5.71
       1.187     0.850000        76073         6.67
       1.211     0.875000        78293         8.00
       1.223     0.887500        79384         8.89
       1.237     0.900000        80531        10.00
       1.255     0.912500        81649        11.43
       1.281     0.925000        82749        13.33
       1.321     0.937500        83833        16.00
       1.347     0.943750        84397        17.78
       1.378     0.950000        84954        20.00
       1.421     0.956250        85516        22.86
       1.472     0.962500        86068        26.67
       1.532     0.968750        86626        32.00
       1.563     0.971875        86906        35.56
       1.599     0.975000        87183        40.00
       1.637     0.978125        87467        45.71
       1.683     0.981250        87746        53.33
       1.727     0.984375        88027        64.00
       1.753     0.985938        88165        71.11
       1.784     0.987500        88301        80.00
       1.818     0.989062        88442        91.43
       1.854     0.990625        88580       106.67
       1.896     0.992188        88722       128.00
       1.919     0.992969        88792       142.22
       1.948     0.993750        88861       160.00
       1.986     0.994531        88931       182.86
       2.032     0.995313        89001       213.33
       2.091     0.996094        89069       256.00
       2.135     0.996484        89104       284.44
       2.191     0.996875        89140       320.00
       2.289     0.997266        89174       365.71
       2.597     0.997656        89209       426.67
       3.125     0.998047        89244       512.00
       3.541     0.998242        89261       568.89
       4.247     0.998437        89279       640.00
       5.027     0.998633        89296       731.43
       6.003     0.998828        89314       853.33
       6.727     0.999023        89331      1024.00
       7.687     0.999121        89340      1137.78
       8.687     0.999219        89349      1280.00
      10.927     0.999316        89357      1462.86
      11.775     0.999414        89367      1706.67
      12.959     0.999512        89375      2048.00
      16.255     0.999561        89379      2275.56
      16.991     0.999609        89384      2560.00
      18.303     0.999658        89388      2925.71
      20.591     0.999707        89392      3413.33
      22.943     0.999756        89397      4096.00
      24.767     0.999780        89399      4551.11
      25.503     0.999805        89401      5120.00
      26.639     0.999829        89403      5851.43
      27.263     0.999854        89405      6826.67
      30.415     0.999878        89408      8192.00
      33.247     0.999890        89409      9102.22
      34.847     0.999902        89410     10240.00
      35.711     0.999915        89411     11702.86
      36.255     0.999927        89412     13653.33
      39.711     0.999939        89413     16384.00
      40.255     0.999945        89414     18204.44
      40.255     0.999951        89414     20480.00
      40.959     0.999957        89415     23405.71
      40.959     0.999963        89415     27306.67
      41.183     0.999969        89416     32768.00
      41.183     0.999973        89416     36408.89
      41.183     0.999976        89416     40960.00
      41.375     0.999979        89417     46811.43
      41.375     0.999982        89417     54613.33
      41.375     0.999985        89417     65536.00
      41.375     0.999986        89417     72817.78
      41.375     0.999988        89417     81920.00
      42.239     0.999989        89418     93622.86
      42.239     1.000000        89418          inf
#[Mean    =        0.837, StdDeviation   =        0.711]
#[Max     =       42.208, Total count    =        89418]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  99474 requests in 2.00m, 7.87MB read
  Socket errors: connect 0, read 0, write 0, timeout 614
Requests/sec:    828.90
Transfer/sec:     67.17KB
```

Итоги:
<ol>
<li>обработано 99474 запросов</li>
<li>прочитано 7.87MB данных</li>
<li>ошибок timeout на запросах - 614</li>
<li>сервер держит нагрузку на уровне 828.90 запросов в секунду</li>
<li>итоговая нагрузка может варьироваться на уровне 600-800 запросов в секунду</li>
</ol>

### GET

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>1000 запросов в секунду</li>
</ol>

![CPU GET](/async-svg/cpu-get.svg)

Ресурсы процессора выделяются на Java-поток (58.77%) (также включает выбор задач из пулла потоков) и селектор потоков onenio (36.97%), остатки уходят на нативные функции Java. Проксирование клиентов, исполнение PUT-запроса и формирование ответа берут ресурсов примерно поровну.

![ALLOC GET](/async-svg/alloc-get.svg)

Память выделяется на Java-поток (63.74%) и селектор потоков onenio (36.26%). Операция проксирования клиентов сервиса занимает 41.37%, остальное уходить на исполнение GET-запроса (19.31%) и формирование ответа (2.22%).

![LOCK GET](/async-svg/lock-get.svg)

Одна блокировка на один Java-поток, так как выполняется однопоточное профилирование. В то же время, ресурсы блокировки делятся на проксирование и отправку ответа на запрос.

```
wrk2 -t4 -c64 -d2m -R1000 -s wrk/get.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.389ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.318ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.287ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.328ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.27ms  493.58us  14.74ms   69.26%
    Req/Sec   263.96     89.19   666.00     79.31%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.26ms
 75.000%    1.60ms
 90.000%    1.88ms
 99.000%    2.38ms
 99.900%    3.01ms
 99.990%   10.41ms
 99.999%   14.53ms
100.000%   14.74ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.098     0.000000            1         1.00
       0.667     0.100000        10997         1.11
       0.845     0.200000        22016         1.25
       0.997     0.300000        32989         1.43
       1.133     0.400000        43995         1.67
       1.260     0.500000        54986         2.00
       1.324     0.550000        60487         2.22
       1.387     0.600000        65965         2.50
       1.453     0.650000        71504         2.86
       1.521     0.700000        76973         3.33
       1.595     0.750000        82484         4.00
       1.634     0.775000        85219         4.44
       1.675     0.800000        88003         5.00
       1.718     0.825000        90719         5.71
       1.765     0.850000        93435         6.67
       1.818     0.875000        96195         8.00
       1.848     0.887500        97576         8.89
       1.880     0.900000        98931        10.00
       1.916     0.912500       100307        11.43
       1.957     0.925000       101695        13.33
       2.007     0.937500       103073        16.00
       2.033     0.943750       103744        17.78
       2.063     0.950000       104443        20.00
       2.093     0.956250       105118        22.86
       2.129     0.962500       105815        26.67
       2.169     0.968750       106510        32.00
       2.191     0.971875       106849        35.56
       2.215     0.975000       107175        40.00
       2.241     0.978125       107522        45.71
       2.271     0.981250       107871        53.33
       2.305     0.984375       108202        64.00
       2.325     0.985938       108369        71.11
       2.347     0.987500       108551        80.00
       2.369     0.989062       108720        91.43
       2.391     0.990625       108882       106.67
       2.419     0.992188       109061       128.00
       2.437     0.992969       109150       142.22
       2.457     0.993750       109227       160.00
       2.479     0.994531       109320       182.86
       2.505     0.995313       109406       213.33
       2.527     0.996094       109483       256.00
       2.545     0.996484       109526       284.44
       2.559     0.996875       109573       320.00
       2.575     0.997266       109613       365.71
       2.607     0.997656       109655       426.67
       2.639     0.998047       109698       512.00
       2.661     0.998242       109719       568.89
       2.693     0.998437       109741       640.00
       2.737     0.998633       109762       731.43
       2.785     0.998828       109784       853.33
       3.059     0.999023       109805      1024.00
       3.353     0.999121       109816      1137.78
       3.753     0.999219       109827      1280.00
       4.059     0.999316       109837      1462.86
       4.495     0.999414       109848      1706.67
       5.095     0.999512       109859      2048.00
       5.383     0.999561       109864      2275.56
       5.759     0.999609       109870      2560.00
       5.931     0.999658       109875      2925.71
       6.399     0.999707       109880      3413.33
       6.843     0.999756       109886      4096.00
       7.071     0.999780       109888      4551.11
       8.003     0.999805       109891      5120.00
       8.455     0.999829       109894      5851.43
       8.839     0.999854       109896      6826.67
      10.255     0.999878       109899      8192.00
      10.343     0.999890       109900      9102.22
      10.415     0.999902       109902     10240.00
      10.599     0.999915       109903     11702.86
      10.687     0.999927       109904     13653.33
      11.167     0.999939       109906     16384.00
      11.167     0.999945       109906     18204.44
      11.431     0.999951       109907     20480.00
      11.743     0.999957       109908     23405.71
      11.743     0.999963       109908     27306.67
      12.439     0.999969       109909     32768.00
      12.439     0.999973       109909     36408.89
      13.999     0.999976       109910     40960.00
      13.999     0.999979       109910     46811.43
      13.999     0.999982       109910     54613.33
      14.527     0.999985       109911     65536.00
      14.527     0.999986       109911     72817.78
      14.527     0.999988       109911     81920.00
      14.527     0.999989       109911     93622.86
      14.527     0.999991       109911    109226.67
      14.743     0.999992       109912    131072.00
      14.743     1.000000       109912          inf
#[Mean    =        1.274, StdDeviation   =        0.494]
#[Max     =       14.736, Total count    =       109912]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  119992 requests in 2.00m, 9.46MB read
  Non-2xx or 3xx responses: 4569
Requests/sec:    999.92
Transfer/sec:     80.72KB
```

Итоги:
<ol>
<li>обработано 119992 запросов</li>
<li>прочитано 9.46MB данных</li>
<li>сервер выдерживает заданную нагрузку на уровне 999.92 запросов в секунду</li>
<li>выдержать заданную нагрузку сервер стал способен после 3 wrk2-тестирований</li>
</ol>