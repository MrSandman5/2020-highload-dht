## Анализ результатов

### PUT

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>1000 запросов в секунду</li>
</ol>

![CPU PUT](/async-svg/cpu-put.svg)

Ресурсы процессора выделяются на Java-поток (69.44%) и селектор потоков onenio (22.22%), остатки уходят на нативные функции Java. Теперь почти половину ресурсов для Java-потока использует функция репликации (33.33%). Реплицированный PUT занимает треть ресурсов потока onenio (8.33%).

![ALLOC PUT](/async-svg/alloc-put.svg)

Память выделяется на Java-поток (38.72%) и селектор потоков onenio (61.28%). Операция репликации использует примерно половину всей памяти, выделенной на Java-поток (18.55%), реплицированный PUT - 4.01%.

![LOCK PUT](/async-svg/lock-put.svg)

Блокировки отсутствуют.

```
wrk2 -t4 -c64 -d2m -R1000 -s wrk/put.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 0.709ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.740ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.578ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.890ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   847.51us  643.48us  33.76ms   97.24%
    Req/Sec    36.45     65.55   333.00     82.47%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  746.00us
 75.000%    1.11ms
 90.000%    1.33ms
 99.000%    1.59ms
 99.900%    7.34ms
 99.990%   23.01ms
 99.999%   33.79ms
100.000%   33.79ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.353     0.000000            1         1.00
       0.439     0.100000         1557         1.11
       0.465     0.200000         3057         1.25
       0.508     0.300000         4561         1.43
       0.624     0.400000         6074         1.67
       0.746     0.500000         7582         2.00
       0.816     0.550000         8352         2.22
       0.909     0.600000         9099         2.50
       1.006     0.650000         9856         2.86
       1.071     0.700000        10622         3.33
       1.114     0.750000        11373         4.00
       1.150     0.775000        11754         4.44
       1.217     0.800000        12132         5.00
       1.254     0.825000        12520         5.71
       1.280     0.850000        12889         6.67
       1.303     0.875000        13274         8.00
       1.315     0.887500        13462         8.89
       1.327     0.900000        13658        10.00
       1.341     0.912500        13842        11.43
       1.357     0.925000        14035        13.33
       1.381     0.937500        14218        16.00
       1.401     0.943750        14312        17.78
       1.419     0.950000        14406        20.00
       1.437     0.956250        14503        22.86
       1.456     0.962500        14596        26.67
       1.476     0.968750        14694        32.00
       1.490     0.971875        14737        35.56
       1.502     0.975000        14785        40.00
       1.516     0.978125        14832        45.71
       1.532     0.981250        14883        53.33
       1.549     0.984375        14928        64.00
       1.558     0.985938        14950        71.11
       1.571     0.987500        14975        80.00
       1.579     0.989062        14998        91.43
       1.604     0.990625        15022       106.67
       1.630     0.992188        15047       128.00
       1.649     0.992969        15057       142.22
       1.676     0.993750        15070       160.00
       1.760     0.994531        15081       182.86
       1.903     0.995313        15092       213.33
       2.463     0.996094        15104       256.00
       2.775     0.996484        15110       284.44
       3.031     0.996875        15116       320.00
       3.587     0.997266        15122       365.71
       4.199     0.997656        15128       426.67
       4.755     0.998047        15134       512.00
       5.111     0.998242        15137       568.89
       6.035     0.998437        15140       640.00
       6.295     0.998633        15143       731.43
       6.803     0.998828        15146       853.33
       7.399     0.999023        15149      1024.00
       8.223     0.999121        15150      1137.78
       8.895     0.999219        15152      1280.00
       9.199     0.999316        15153      1462.86
       9.823     0.999414        15155      1706.67
      10.927     0.999512        15156      2048.00
      11.791     0.999561        15157      2275.56
      11.895     0.999609        15158      2560.00
      11.895     0.999658        15158      2925.71
      17.791     0.999707        15159      3413.33
      19.183     0.999756        15160      4096.00
      19.183     0.999780        15160      4551.11
      23.007     0.999805        15161      5120.00
      23.007     0.999829        15161      5851.43
      23.007     0.999854        15161      6826.67
      29.519     0.999878        15162      8192.00
      29.519     0.999890        15162      9102.22
      29.519     0.999902        15162     10240.00
      29.519     0.999915        15162     11702.86
      29.519     0.999927        15162     13653.33
      33.791     0.999939        15163     16384.00
      33.791     1.000000        15163          inf
#[Mean    =        0.848, StdDeviation   =        0.643]
#[Max     =       33.760, Total count    =        15163]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  20037 requests in 2.00m, 1.28MB read
  Socket errors: connect 0, read 0, write 0, timeout 3131
Requests/sec:    166.87
Transfer/sec:     10.92KB
```

Итоги:
<ol>
<li>обработано 20037 запросов</li>
<li>прочитано 1.28MB данных</li>
<li>ошибок timeout на запросах - 3131</li>
<li>сервер не выдерживает заданную нагрузку - 166.87 зап/с</li>
<li>даже после "прогрева" сервер не может выдерживать нагрузку</li>
<li>средняя итоговая нагрузка находится в диапазоне 80-130 зап/с</li>
<li>при уменьшении заданной нагрузки до 200 зап/с и ниже итоговая нагрузка в большинстве случаев равна половине от заданной</li>
</ol>

### GET

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>1000 запросов в секунду</li>
</ol>

![CPU GET](/async-svg/cpu-get.svg)

Ресурсы процессора выделяются на Java-поток (65.12%) и селектор потоков onenio (27.91%), остатки уходят на нативные функции Java. Большую часть ресурсов для Java-потока используют операция репликации (30.23%) и реплицированный GET (итерация по DAO и преобразование в Entry) - (18.6%).

![ALLOC GET](/async-svg/alloc-get.svg)

Память выделяется на Java-поток (38.4%) и селектор потоков onenio (61.2%). Операция репликации использует 21.91% всей памяти, реплицированный PUT - 13.4%.

![LOCK GET](/async-svg/lock-get.svg)

Блокировки отсутствуют.

```
wrk2 -t4 -c64 -d2m -R1000 -s wrk/get.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 0.694ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.057ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 0.730ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.432ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.96ms  797.93us  38.24ms   97.85%
    Req/Sec    24.44     49.43   333.00     78.82%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%  776.00us
 75.000%    1.29ms
 90.000%    1.50ms
 99.000%    2.08ms
 99.900%    9.26ms
 99.990%   26.64ms
 99.999%   38.27ms
100.000%   38.27ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.340     0.000000            1         1.00
       0.480     0.100000         1021         1.11
       0.523     0.200000         2044         1.25
       0.592     0.300000         3052         1.43
       0.686     0.400000         4076         1.67
       0.776     0.500000         5086         2.00
       0.866     0.550000         5595         2.22
       1.102     0.600000         6109         2.50
       1.152     0.650000         6613         2.86
       1.222     0.700000         7121         3.33
       1.289     0.750000         7626         4.00
       1.314     0.775000         7883         4.44
       1.341     0.800000         8146         5.00
       1.366     0.825000         8394         5.71
       1.401     0.850000         8645         6.67
       1.450     0.875000         8897         8.00
       1.476     0.887500         9023         8.89
       1.501     0.900000         9159        10.00
       1.525     0.912500         9279        11.43
       1.545     0.925000         9406        13.33
       1.571     0.937500         9533        16.00
       1.588     0.943750         9596        17.78
       1.604     0.950000         9664        20.00
       1.625     0.956250         9725        22.86
       1.652     0.962500         9786        26.67
       1.685     0.968750         9849        32.00
       1.700     0.971875         9881        35.56
       1.722     0.975000         9912        40.00
       1.752     0.978125         9944        45.71
       1.807     0.981250         9977        53.33
       1.863     0.984375        10008        64.00
       1.907     0.985938        10024        71.11
       1.949     0.987500        10039        80.00
       1.997     0.989062        10055        91.43
       2.133     0.990625        10072       106.67
       2.389     0.992188        10087       128.00
       2.599     0.992969        10095       142.22
       2.981     0.993750        10103       160.00
       3.467     0.994531        10111       182.86
       3.769     0.995313        10119       213.33
       4.411     0.996094        10127       256.00
       4.907     0.996484        10131       284.44
       5.235     0.996875        10135       320.00
       5.647     0.997266        10139       365.71
       5.755     0.997656        10143       426.67
       6.215     0.998047        10147       512.00
       6.443     0.998242        10149       568.89
       6.995     0.998437        10151       640.00
       7.983     0.998633        10153       731.43
       8.975     0.998828        10155       853.33
      10.207     0.999023        10158      1024.00
      10.207     0.999121        10158      1137.78
      10.223     0.999219        10159      1280.00
      12.831     0.999316        10160      1462.86
      13.967     0.999414        10161      1706.67
      14.375     0.999512        10162      2048.00
      14.375     0.999561        10162      2275.56
      22.383     0.999609        10163      2560.00
      22.383     0.999658        10163      2925.71
      24.063     0.999707        10164      3413.33
      24.063     0.999756        10164      4096.00
      24.063     0.999780        10164      4551.11
      26.639     0.999805        10165      5120.00
      26.639     0.999829        10165      5851.43
      26.639     0.999854        10165      6826.67
      26.639     0.999878        10165      8192.00
      26.639     0.999890        10165      9102.22
      38.271     0.999902        10166     10240.00
      38.271     1.000000        10166          inf
#[Mean    =        0.964, StdDeviation   =        0.798]
#[Max     =       38.240, Total count    =        10166]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  14511 requests in 2.00m, 1.27MB read
  Socket errors: connect 0, read 0, write 0, timeout 3292
Requests/sec:    120.86
Transfer/sec:     10.82KB
```

Итоги:
<ol>
<li>обработано 14511 запросов</li>
<li>прочитано 1.27MB данных</li>
<li>сервер не выдерживает заданную нагрузку - 120.86 зап/с</li>
<li>даже после "прогрева" сервер не может выдерживать нагрузку</li>
<li>средняя итоговая нагрузка находится в диапазоне 70-120 зап/с</li>
<li>при уменьшении заданной нагрузки до 200 зап/с и ниже итоговая нагрузка в большинстве случаев равна половине от заданной</li>
</ol>

##Выводы

После реализации репликации для http-сервиса допустимая нагрузка уменьшилась в среднем в 7-9 раз. Скорость исполнения запросов при этом кардинально не уменьшилось, а количество timeout-ошибок возросло многократно.