## Анализ результатов

### PUT

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>2500 запросов в секунду</li>
</ol>

![CPU PUT](/async-svg/cpu-put.svg)

Ресурсы процессора выделяются на Java-поток (57.5%) и селектор потоков onenio (27.72%), остатки уходят на нативные вызовы Java. Теперь почти половину ресурсов для Java-потока использует функция репликации (25.57%). Реплицированный PUT занимает пятую часть ресурсов потока onenio (4.24%).

![ALLOC PUT](/async-svg/alloc-put.svg)

Память выделяется на Java-поток (61.05%) и селектор потоков onenio (38.95%). Операция репликации использует примерно половину всей памяти, выделенной на Java-поток (26.8%), реплицированный PUT - 2.04%.

![LOCK PUT](/async-svg/lock-put.svg)

Блокировки выделяются на Java-поток (54.38%) и селектор потоков onenio (45.62%).

```
wrk2 -t4 -c64 -d2m -R2500 -s wrk/put.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.607ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 2.109ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.563ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.568ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.67ms    1.93ms  69.06ms   96.85%
    Req/Sec   658.18    407.23     4.80k    75.09%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.40ms
 75.000%    1.84ms
 90.000%    2.36ms
 99.000%    8.53ms
 99.900%   27.02ms
 99.990%   58.08ms
 99.999%   68.29ms
100.000%   69.12ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.150     0.000000            1         1.00
       0.738     0.100000        27493         1.11
       0.942     0.200000        55052         1.25
       1.103     0.300000        82554         1.43
       1.251     0.400000       109943         1.67
       1.402     0.500000       137537         2.00
       1.480     0.550000       151212         2.22
       1.562     0.600000       164964         2.50
       1.646     0.650000       178647         2.86
       1.738     0.700000       192414         3.33
       1.840     0.750000       206135         4.00
       1.898     0.775000       212995         4.44
       1.963     0.800000       219877         5.00
       2.038     0.825000       226769         5.71
       2.125     0.850000       233698         6.67
       2.229     0.875000       240548         8.00
       2.291     0.887500       243976         8.89
       2.361     0.900000       247354        10.00
       2.439     0.912500       250790        11.43
       2.537     0.925000       254229        13.33
       2.667     0.937500       257640        16.00
       2.755     0.943750       259369        17.78
       2.869     0.950000       261073        20.00
       3.029     0.956250       262785        22.86
       3.261     0.962500       264511        26.67
       3.621     0.968750       266220        32.00
       3.881     0.971875       267081        35.56
       4.191     0.975000       267939        40.00
       4.639     0.978125       268801        45.71
       5.219     0.981250       269656        53.33
       6.091     0.984375       270518        64.00
       6.655     0.985938       270945        71.11
       7.263     0.987500       271371        80.00
       7.983     0.989062       271802        91.43
       8.919     0.990625       272232       106.67
      10.095     0.992188       272661       128.00
      10.695     0.992969       272874       142.22
      11.327     0.993750       273090       160.00
      12.135     0.994531       273304       182.86
      13.271     0.995313       273519       213.33
      14.455     0.996094       273735       256.00
      15.303     0.996484       273840       284.44
      16.511     0.996875       273948       320.00
      17.839     0.997266       274055       365.71
      19.423     0.997656       274162       426.67
      20.991     0.998047       274270       512.00
      21.967     0.998242       274324       568.89
      23.183     0.998437       274377       640.00
      24.351     0.998633       274431       731.43
      25.535     0.998828       274484       853.33
      27.183     0.999023       274538      1024.00
      28.431     0.999121       274566      1137.78
      29.743     0.999219       274592      1280.00
      31.295     0.999316       274619      1462.86
      33.119     0.999414       274645      1706.67
      34.751     0.999512       274672      2048.00
      36.031     0.999561       274686      2275.56
      36.767     0.999609       274699      2560.00
      37.855     0.999658       274713      2925.71
      41.343     0.999707       274726      3413.33
      46.271     0.999756       274739      4096.00
      49.343     0.999780       274746      4551.11
      52.799     0.999805       274753      5120.00
      54.655     0.999829       274760      5851.43
      56.031     0.999854       274767      6826.67
      56.863     0.999878       274773      8192.00
      57.471     0.999890       274776      9102.22
      58.239     0.999902       274780     10240.00
      58.623     0.999915       274783     11702.86
      59.359     0.999927       274786     13653.33
      63.551     0.999939       274790     16384.00
      63.839     0.999945       274791     18204.44
      64.031     0.999951       274793     20480.00
      64.319     0.999957       274795     23405.71
      64.479     0.999963       274796     27306.67
      66.623     0.999969       274798     32768.00
      67.775     0.999973       274799     36408.89
      67.967     0.999976       274800     40960.00
      68.095     0.999979       274801     46811.43
      68.095     0.999982       274801     54613.33
      68.223     0.999985       274802     65536.00
      68.287     0.999986       274803     72817.78
      68.287     0.999988       274803     81920.00
      68.607     0.999989       274804     93622.86
      68.607     0.999991       274804    109226.67
      68.607     0.999992       274804    131072.00
      68.991     0.999993       274805    145635.56
      68.991     0.999994       274805    163840.00
      68.991     0.999995       274805    187245.71
      68.991     0.999995       274805    218453.33
      68.991     0.999996       274805    262144.00
      69.119     0.999997       274806    291271.11
      69.119     1.000000       274806          inf
#[Mean    =        1.666, StdDeviation   =        1.930]
#[Max     =       69.056, Total count    =       274806]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  299340 requests in 2.00m, 19.13MB read
Requests/sec:   2494.15
Transfer/sec:    163.19KB
```

Итоги:
<ol>
<li>обработано 299340 запросов</li>
<li>прочитано 19.13MB данных</li>
<li>сервер выдерживает заданную нагрузку на уровне 2494.15 зап/с</li>
</ol>

### GET

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>750 запросов в секунду</li>
</ol>

![CPU GET](/async-svg/cpu-get.svg)

Ресурсы процессора выделяются на Java-поток (95.83%) и селектор потоков onenio (3.09%), остатки уходят на нативные вызовы Java. Операция репликации использует треть ресурсов Java-потока (33.28%).

![ALLOC GET](/async-svg/alloc-get.svg)

Память выделяется на Java-поток (80%) и селектор потоков onenio (20%). Операция репликации использует 33.09% всей памяти.

![LOCK GET](/async-svg/lock-get.svg)

Блокировки выделяются на Java-поток (91%) и селектор потоков onenio (9%).

```
wrk2 -t4 -c64 -d2m -R750 -s wrk/get.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 4.346ms, rate sampling interval: 13ms
  Thread calibration: mean lat.: 4.322ms, rate sampling interval: 13ms
  Thread calibration: mean lat.: 4.323ms, rate sampling interval: 13ms
  Thread calibration: mean lat.: 4.330ms, rate sampling interval: 13ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.96ms    4.05ms  70.66ms   96.09%
    Req/Sec   194.58     52.10   583.00     72.44%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    4.26ms
 75.000%    5.38ms
 90.000%    6.85ms
 99.000%   23.84ms
 99.900%   52.70ms
 99.990%   63.26ms
 99.999%   69.31ms
100.000%   70.72ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       1.570     0.000000            1         1.00
       2.713     0.100000         8269         1.11
       3.119     0.200000        16523         1.25
       3.503     0.300000        24765         1.43
       3.887     0.400000        32995         1.67
       4.255     0.500000        41237         2.00
       4.447     0.550000        45399         2.22
       4.631     0.600000        49475         2.50
       4.843     0.650000        53614         2.86
       5.083     0.700000        57728         3.33
       5.375     0.750000        61865         4.00
       5.555     0.775000        63927         4.44
       5.759     0.800000        65971         5.00
       5.995     0.825000        68021         5.71
       6.255     0.850000        70079         6.67
       6.527     0.875000        72166         8.00
       6.683     0.887500        73167         8.89
       6.851     0.900000        74214        10.00
       7.039     0.912500        75229        11.43
       7.271     0.925000        76258        13.33
       7.591     0.937500        77294        16.00
       7.819     0.943750        77806        17.78
       8.111     0.950000        78321        20.00
       8.527     0.956250        78835        22.86
       9.271     0.962500        79350        26.67
      10.503     0.968750        79867        32.00
      11.263     0.971875        80123        35.56
      12.255     0.975000        80380        40.00
      13.631     0.978125        80638        45.71
      15.503     0.981250        80895        53.33
      17.935     0.984375        81153        64.00
      19.183     0.985938        81283        71.11
      20.847     0.987500        81411        80.00
      22.591     0.989062        81540        91.43
      24.719     0.990625        81668       106.67
      27.183     0.992188        81797       128.00
      28.879     0.992969        81861       142.22
      30.303     0.993750        81925       160.00
      32.543     0.994531        81991       182.86
      34.719     0.995313        82054       213.33
      38.271     0.996094        82118       256.00
      41.087     0.996484        82151       284.44
      42.527     0.996875        82185       320.00
      44.383     0.997266        82215       365.71
      46.079     0.997656        82247       426.67
      47.551     0.998047        82279       512.00
      48.639     0.998242        82296       568.89
      49.599     0.998437        82315       640.00
      50.591     0.998633        82328       731.43
      51.551     0.998828        82344       853.33
      52.959     0.999023        82360      1024.00
      53.983     0.999121        82369      1137.78
      54.527     0.999219        82377      1280.00
      55.871     0.999316        82384      1462.86
      56.287     0.999414        82395      1706.67
      57.183     0.999512        82400      2048.00
      57.919     0.999561        82404      2275.56
      58.591     0.999609        82408      2560.00
      59.263     0.999658        82412      2925.71
      59.743     0.999707        82416      3413.33
      60.191     0.999756        82420      4096.00
      61.087     0.999780        82422      4551.11
      61.727     0.999805        82424      5120.00
      61.887     0.999829        82426      5851.43
      62.111     0.999854        82428      6826.67
      62.335     0.999878        82430      8192.00
      62.911     0.999890        82431      9102.22
      63.263     0.999902        82432     10240.00
      63.711     0.999915        82433     11702.86
      63.999     0.999927        82434     13653.33
      64.639     0.999939        82435     16384.00
      64.671     0.999945        82436     18204.44
      64.671     0.999951        82436     20480.00
      66.815     0.999957        82437     23405.71
      66.815     0.999963        82437     27306.67
      68.287     0.999969        82438     32768.00
      68.287     0.999973        82438     36408.89
      68.287     0.999976        82438     40960.00
      69.311     0.999979        82439     46811.43
      69.311     0.999982        82439     54613.33
      69.311     0.999985        82439     65536.00
      69.311     0.999986        82439     72817.78
      69.311     0.999988        82439     81920.00
      70.719     0.999989        82440     93622.86
      70.719     1.000000        82440          inf
#[Mean    =        4.964, StdDeviation   =        4.051]
#[Max     =       70.656, Total count    =        82440]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  90003 requests in 2.00m, 7.94MB read
Requests/sec:    750.01
Transfer/sec:     67.75KB
```

Итоги:
<ol>
<li>обработано 90003 запросов</li>
<li>прочитано 7.94MB данных</li>
<li>сервер выдерживает заданную нагрузку на уровне 750.01 зап/с</li>
</ol>

##Выводы

После реализации репликации для http-сервиса допустимая нагрузка PUT-запросами выросла с 1000 зап/с до 2500 зап/с. В то же время допустимая нагрузка GET-запросами уменьшилась с 1000 зап/с до 750 зап/с. Скорость исполнения запросов при этом кардинально не уменьшилась.
При анализе профилирование не было обнаружено существенных изменений в использовании ресурсов для PUT-запросов. Однако, в GET-запросах б*о*льшую часть всех ресурсов (процессор, память, блокировки) использует Java-поток сервиса (доля превышает 90%). 