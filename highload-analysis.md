## Анализ результатов

### PUT

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>1000 запросов в секунду</li>
</ol>

![CPU PUT](/async-svg/cpu-put.svg)

Ресурсы процессора выделяются на Java-поток (57.89%) (также включает выбор задач из пулла потоков) и селектор потоков onenio (38.16%), остатки уходят на нативные функции Java. Проксирование клиентов, исполнение PUT-запроса и формирование ответа берут ресурсов примерно поровну.

![ALLOC PUT](/async-svg/alloc-put.svg)

Память выделяется на Java-поток (67.26%) и селектор потоков onenio (32.74%). Операция проксирования клиентов сервиса занимает 48.21%, остальное уходить на исполнение PUT-запроса (13.91%) и формирование ответа (4.61%).

![LOCK PUT](/async-svg/lock-put.svg)

Одна блокировка на один Java-поток, так как выполняется однопоточное профилирование. В то же время, ресурсы блокировки делятся на проксирование и отправку ответа на запрос.

```
wrk2 -t4 -c64 -d2m -R1000 -s wrk/put.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.138ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.153ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.218ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.150ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.01ms  563.34us  19.73ms   79.72%
    Req/Sec   258.28     96.55   666.00     74.76%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.96ms
 75.000%    1.27ms
 90.000%    1.61ms
 99.000%    2.26ms
 99.900%    5.83ms
 99.990%   16.58ms
 99.999%   19.30ms
100.000%   19.74ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.092     0.000000            1         1.00
       0.463     0.100000        10767         1.11
       0.603     0.200000        21429         1.25
       0.723     0.300000        32178         1.43
       0.845     0.400000        42900         1.67
       0.956     0.500000        53556         2.00
       1.016     0.550000        58913         2.22
       1.076     0.600000        64342         2.50
       1.137     0.650000        69645         2.86
       1.202     0.700000        75021         3.33
       1.275     0.750000        80397         4.00
       1.313     0.775000        83046         4.44
       1.356     0.800000        85717         5.00
       1.408     0.825000        88408         5.71
       1.466     0.850000        91075         6.67
       1.532     0.875000        93730         8.00
       1.569     0.887500        95070         8.89
       1.609     0.900000        96415        10.00
       1.651     0.912500        97761        11.43
       1.697     0.925000        99101        13.33
       1.752     0.937500       100425        16.00
       1.784     0.943750       101088        17.78
       1.819     0.950000       101768        20.00
       1.858     0.956250       102436        22.86
       1.900     0.962500       103103        26.67
       1.951     0.968750       103777        32.00
       1.976     0.971875       104102        35.56
       2.008     0.975000       104445        40.00
       2.040     0.978125       104772        45.71
       2.079     0.981250       105105        53.33
       2.127     0.984375       105448        64.00
       2.157     0.985938       105620        71.11
       2.191     0.987500       105786        80.00
       2.229     0.989062       105948        91.43
       2.275     0.990625       106107       106.67
       2.335     0.992188       106279       128.00
       2.371     0.992969       106359       142.22
       2.429     0.993750       106442       160.00
       2.491     0.994531       106526       182.86
       2.581     0.995313       106609       213.33
       2.751     0.996094       106693       256.00
       2.895     0.996484       106735       284.44
       3.105     0.996875       106777       320.00
       3.381     0.997266       106819       365.71
       3.643     0.997656       106860       426.67
       4.081     0.998047       106902       512.00
       4.363     0.998242       106923       568.89
       4.695     0.998437       106944       640.00
       4.963     0.998633       106965       731.43
       5.287     0.998828       106986       853.33
       5.843     0.999023       107007      1024.00
       6.087     0.999121       107017      1137.78
       6.791     0.999219       107028      1280.00
       7.291     0.999316       107038      1462.86
       8.163     0.999414       107049      1706.67
       8.919     0.999512       107059      2048.00
       9.679     0.999561       107064      2275.56
      10.079     0.999609       107070      2560.00
      10.815     0.999658       107075      2925.71
      13.103     0.999707       107080      3413.33
      13.463     0.999756       107085      4096.00
      13.879     0.999780       107088      4551.11
      14.663     0.999805       107092      5120.00
      14.863     0.999829       107093      5851.43
      15.183     0.999854       107096      6826.67
      16.087     0.999878       107098      8192.00
      16.575     0.999890       107100      9102.22
      17.279     0.999902       107101     10240.00
      17.295     0.999915       107102     11702.86
      17.855     0.999927       107104     13653.33
      17.887     0.999939       107105     16384.00
      17.967     0.999945       107106     18204.44
      17.967     0.999951       107106     20480.00
      18.239     0.999957       107107     23405.71
      18.559     0.999963       107108     27306.67
      18.559     0.999969       107108     32768.00
      18.799     0.999973       107109     36408.89
      18.799     0.999976       107109     40960.00
      18.799     0.999979       107109     46811.43
      19.295     0.999982       107110     54613.33
      19.295     0.999985       107110     65536.00
      19.295     0.999986       107110     72817.78
      19.295     0.999988       107110     81920.00
      19.295     0.999989       107110     93622.86
      19.743     0.999991       107111    109226.67
      19.743     1.000000       107111          inf
#[Mean    =        1.015, StdDeviation   =        0.563]
#[Max     =       19.728, Total count    =       107111]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  117190 requests in 2.00m, 9.27MB read
  Socket errors: connect 0, read 0, write 0, timeout 83
Requests/sec:    976.58
Transfer/sec:     79.12KB
```

Итоги:
<ol>
<li>обработано 117190 запросов</li>
<li>прочитано 9.27MB данных</li>
<li>ошибок timeout на запросах - 83</li>
<li>сервер держит нагрузку на уровне 976.58 запросов в секунду</li>
<li>выдержать заданную нагрузку сервер стал способен после 3 wrk2-тестирований</li>
<li>итоговая нагрузка может варьироваться на уровне 700-1000 запросов в секунду даже после прогревания</li>
</ol>

### GET

Параметры запуска:
<ol>
<li>4 потока</li>
<li>64 открытых соединения</li>
<li>2 минуты работы</li>
<li>1000 запросов в секунду</li>
</ol>

![CPU GET](/async-svg/cpu-get.svg)

Ресурсы процессора выделяются на Java-поток (58.77%) (также включает выбор задач из пулла потоков) и селектор потоков onenio (36.97%), остатки уходят на нативные функции Java. Проксирование клиентов, исполнение PUT-запроса и формирование ответа берут ресурсов примерно поровну.

![ALLOC GET](/async-svg/alloc-get.svg)

Память выделяется на Java-поток (63.74%) и селектор потоков onenio (36.26%). Операция проксирования клиентов сервиса занимает 41.37%, остальное уходить на исполнение GET-запроса (19.31%) и формирование ответа (2.22%).

![LOCK GET](/async-svg/lock-get.svg)

Одна блокировка на один Java-поток, так как выполняется однопоточное профилирование. В то же время, ресурсы блокировки делятся на проксирование и отправку ответа на запрос.

```
wrk2 -t4 -c64 -d2m -R1000 -s wrk/get.lua --latency http://127.0.0.1:8080
Running 2m test @ http://127.0.0.1:8080
  4 threads and 64 connections
  Thread calibration: mean lat.: 1.389ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.318ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.287ms, rate sampling interval: 10ms
  Thread calibration: mean lat.: 1.328ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.27ms  493.58us  14.74ms   69.26%
    Req/Sec   263.96     89.19   666.00     79.31%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.26ms
 75.000%    1.60ms
 90.000%    1.88ms
 99.000%    2.38ms
 99.900%    3.01ms
 99.990%   10.41ms
 99.999%   14.53ms
100.000%   14.74ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.098     0.000000            1         1.00
       0.667     0.100000        10997         1.11
       0.845     0.200000        22016         1.25
       0.997     0.300000        32989         1.43
       1.133     0.400000        43995         1.67
       1.260     0.500000        54986         2.00
       1.324     0.550000        60487         2.22
       1.387     0.600000        65965         2.50
       1.453     0.650000        71504         2.86
       1.521     0.700000        76973         3.33
       1.595     0.750000        82484         4.00
       1.634     0.775000        85219         4.44
       1.675     0.800000        88003         5.00
       1.718     0.825000        90719         5.71
       1.765     0.850000        93435         6.67
       1.818     0.875000        96195         8.00
       1.848     0.887500        97576         8.89
       1.880     0.900000        98931        10.00
       1.916     0.912500       100307        11.43
       1.957     0.925000       101695        13.33
       2.007     0.937500       103073        16.00
       2.033     0.943750       103744        17.78
       2.063     0.950000       104443        20.00
       2.093     0.956250       105118        22.86
       2.129     0.962500       105815        26.67
       2.169     0.968750       106510        32.00
       2.191     0.971875       106849        35.56
       2.215     0.975000       107175        40.00
       2.241     0.978125       107522        45.71
       2.271     0.981250       107871        53.33
       2.305     0.984375       108202        64.00
       2.325     0.985938       108369        71.11
       2.347     0.987500       108551        80.00
       2.369     0.989062       108720        91.43
       2.391     0.990625       108882       106.67
       2.419     0.992188       109061       128.00
       2.437     0.992969       109150       142.22
       2.457     0.993750       109227       160.00
       2.479     0.994531       109320       182.86
       2.505     0.995313       109406       213.33
       2.527     0.996094       109483       256.00
       2.545     0.996484       109526       284.44
       2.559     0.996875       109573       320.00
       2.575     0.997266       109613       365.71
       2.607     0.997656       109655       426.67
       2.639     0.998047       109698       512.00
       2.661     0.998242       109719       568.89
       2.693     0.998437       109741       640.00
       2.737     0.998633       109762       731.43
       2.785     0.998828       109784       853.33
       3.059     0.999023       109805      1024.00
       3.353     0.999121       109816      1137.78
       3.753     0.999219       109827      1280.00
       4.059     0.999316       109837      1462.86
       4.495     0.999414       109848      1706.67
       5.095     0.999512       109859      2048.00
       5.383     0.999561       109864      2275.56
       5.759     0.999609       109870      2560.00
       5.931     0.999658       109875      2925.71
       6.399     0.999707       109880      3413.33
       6.843     0.999756       109886      4096.00
       7.071     0.999780       109888      4551.11
       8.003     0.999805       109891      5120.00
       8.455     0.999829       109894      5851.43
       8.839     0.999854       109896      6826.67
      10.255     0.999878       109899      8192.00
      10.343     0.999890       109900      9102.22
      10.415     0.999902       109902     10240.00
      10.599     0.999915       109903     11702.86
      10.687     0.999927       109904     13653.33
      11.167     0.999939       109906     16384.00
      11.167     0.999945       109906     18204.44
      11.431     0.999951       109907     20480.00
      11.743     0.999957       109908     23405.71
      11.743     0.999963       109908     27306.67
      12.439     0.999969       109909     32768.00
      12.439     0.999973       109909     36408.89
      13.999     0.999976       109910     40960.00
      13.999     0.999979       109910     46811.43
      13.999     0.999982       109910     54613.33
      14.527     0.999985       109911     65536.00
      14.527     0.999986       109911     72817.78
      14.527     0.999988       109911     81920.00
      14.527     0.999989       109911     93622.86
      14.527     0.999991       109911    109226.67
      14.743     0.999992       109912    131072.00
      14.743     1.000000       109912          inf
#[Mean    =        1.274, StdDeviation   =        0.494]
#[Max     =       14.736, Total count    =       109912]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  119992 requests in 2.00m, 9.46MB read
  Non-2xx or 3xx responses: 4569
Requests/sec:    999.92
Transfer/sec:     80.72KB
```

Итоги:
<ol>
<li>обработано 119992 запросов</li>
<li>прочитано 9.46MB данных</li>
<li>сервер выдерживает заданную нагрузку на уровне 999.92 запросов в секунду</li>
<li>выдержать заданную нагрузку сервер стал способен после 3 wrk2-тестирований</li>
</ol>

## Выводы

В результате реализации шардирования http-сервис стал обрабатывать меньше запросов при стабильно быстрой их обработке. Это связано с пользовательской реализацией LSM-хранилища и проксированием запросов пользователей. Для примера, максимальное число PUT-запросов при нагрузочном тестировании снизилось до 1000 зап/с с падениями до 700 зап/с, причём данные значения достигаются только после полноценного "прогрева". Максимальное число GET-запросов при нагрузочном тестировании снизилось с 1500 зап/с до 1000 зап/с при предварительном "прогреве". Также было принято решение увеличить таймаут http-клиентов до 1 с для обработки большинства запросов.